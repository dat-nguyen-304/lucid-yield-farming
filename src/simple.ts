import {
  Blockfrost,
  CML as C,
  toHex,
  fromHex,
  Constr,
  Data,
  Lucid,
  LucidEvolution,
  credentialToRewardAddress,
  TxBuilder,
  TxSignBuilder,
  Kupmios,
} from "@lucid-evolution/lucid";
import { apiResponse } from "./apiResponse.js";
import type { Assets, UTxO, OutRef, Script } from "@lucid-evolution/lucid";
import type {
  ApiUtxo,
  ApiResponse,
  ApiMultiAsset,
  ApiData,
  ApiReferenceInput,
  FloatPoolDatum,
} from "./apiResponse.js";
// --- Type definitions for better code clarity and safety ---
const now = parseInt(
  // The non-null assertions (!) are safe here because we know our static
  // apiResponse object contains these values.
  (apiResponse.data.outputs.floatPoolOutUtxo!.datum! as FloatPoolDatum)
    .interestTime,
  10
);

// IMPORTANT: Replace this with your actual 24-word seed phrase.
// It's recommended to load this from a secure environment variable.
const seedPhrase =
  "fork target sense patient museum unusual rough hair brief misery main duty below garbage pizza oval truth invite vessel father flame repair ketchup field";

const submitRawTx = async () => {
  console.log("Attempting to submit raw transaction CBOR...");

  // The transaction CBOR you provided.
  const txCbor =
    "84ad00d90102838258202647ec8e69ad90007309ea5acf137e6946245908791d1cfd81f704054889eb3d03825820367dda134c1341bfb3af980627540e213c909a7618972e2a50c6b7ee01ddcfe301825820367dda134c1341bfb3af980627540e213c909a7618972e2a50c6b7ee01ddcfe3020185a300581d707b595fd9e70b625caeace2e20ac91f292e4cc7f510a23fb71916b76b01821b0000000565f239e4a2581c5bc56ab821b1efbce5be150bd97613c577f32167611211ef742c71f0a1581c32c41815d270a4cc8be4bc9d3d171546b44d36cb57aa7b8b0561855801581c7aa4312097def38936c7b69fb380f9e8685dfa17c52c68151781ea03a1401b0000004bcbf53680028201d818584dd8799f1b00000055b89e07961b000000550942ee9c1a6cb834671901f41a0003d3f11b000000ea8d9ceb001b0000019998e3ad909fd8799f1b000000bc4ae316821b000000b29fb72acfffffffa300583910fbfe1688e61ff0e52da1ccbaf1b3a601c66b670272ddb5e197ca39bd0745b7e415e1757f4cb58e3cc85d12c101078214546880cae6151abb01821a0022002ea2581c7b595fd9e70b625caeace2e20ac91f292e4cc7f510a23fb71916b76ba1581c32c41815d270a4cc8be4bc9d3d171546b44d36cb57aa7b8b056185581a35372c6e581cfbfe1688e61ff0e52da1ccbaf1b3a601c66b670272ddb5e197ca39bda1581cd7000e63ca9c98a00a81ae804c23ea20714cd8671ddfdb871a5618b801028201d8185899d8799f9f9f581c7b595fd9e70b625caeace2e20ac91f292e4cc7f510a23fb71916b76b581c32c41815d270a4cc8be4bc9d3d171546b44d36cb57aa7b8b05618558ff9f4040ffff1a3b9ac9ff1a3b9ac9ff1b000001999d119800a19f581c919d4c2c9455016289341b1a14dedf697687af31751170d56a31466e4574444a4544ff191f401907d01907081a03dcc50001d879801a05f5e100ff82581d601e12f4c64e2748ec5ad3038099d402c7c1ccb96a562a8d1e70dbcabf1a000f4241a300583910e1a6483473a5d6108ed2ed7f452a2d5b3bec5aeabbe333bf5e6b25050745b7e415e1757f4cb58e3cc85d12c101078214546880cae6151abb01821a001e8480a2581c919d4c2c9455016289341b1a14dedf697687af31751170d56a31466ea14574444a45441a088281e1581ce1a6483473a5d6108ed2ed7f452a2d5b3bec5aeabbe333bf5e6b2505a1581cd7000e63ca9c98a00a81ae804c23ea20714cd8671ddfdb871a5618b801028201d8185839d8799f1a000295641a060fb6e01b000001999a2d449058202d58c81e6dd433b06c20de729c4ecb6a54cbc8778dbf670d176c22793dc533b6ff82583900670dc6e123e04c2a75fa2a08593388f9441fdb7166f55487498d2e3e0745b7e415e1757f4cb58e3cc85d12c101078214546880cae6151abb821b00000002137bb234a3581cfbfe1688e61ff0e52da1ccbaf1b3a601c66b670272ddb5e197ca39bda2581f50542daf0c66b7e4dd73c30ca6a9177dbb9479d41983a673f6e9916124b7a11a3b9ac9ff581f59542daf0c66b7e4dd73c30ca6a9177dbb9479d41983a673f6e9916124b7a11a3b9ac9ff581c919d4c2c9455016289341b1a14dedf697687af31751170d56a31466ead4574414749581b000000174876e8004574434f50491a3b9aca0044744441491a3b9aca004574444a45441a3318481f44744552471b000000e8d4a5100044744941471a3b9aca004574495553441a3b9aca0044744d494e1a3b9aca0045745348454e1a3b9aca004574534e454b1903e84574555344431b000000174876e8004574555344541b000000174876e8004474574d541a3b9aca00581ce1a6483473a5d6108ed2ed7f452a2d5b3bec5aeabbe333bf5e6b2505a158202d58c81e6dd433b06c20de729c4ecb6a54cbc8778dbf670d176c22793dc533b601021a001ed17b031a0584374605a1581df0a2fa8564c279ca144d69bbbd37057f5d3d42e59555bc3bfb874919f600081a0584361a09a2581c7b595fd9e70b625caeace2e20ac91f292e4cc7f510a23fb71916b76ba1581c32c41815d270a4cc8be4bc9d3d171546b44d36cb57aa7b8b056185583a05e9af94581ce1a6483473a5d6108ed2ed7f452a2d5b3bec5aeabbe333bf5e6b2505a258202d58c81e6dd433b06c20de729c4ecb6a54cbc8778dbf670d176c22793dc533b601581cd7000e63ca9c98a00a81ae804c23ea20714cd8671ddfdb871a5618b8010b582058cf678bf1727fff60f4c5f4be8edf347198adc5cedc1be8371e4127e8dbc5ed0dd9010281825820d2ec8f6d275dfefd548af5022a0ffe626a3c9fa6a87c43fa8502391ce4acaa35030ed9010281581c670dc6e123e04c2a75fa2a08593388f9441fdb7166f55487498d2e3e1082583900670dc6e123e04c2a75fa2a08593388f9441fdb7166f55487498d2e3e0745b7e415e1757f4cb58e3cc85d12c101078214546880cae6151abb821b000000058eeff6e1a7581cfbfe1688e61ff0e52da1ccbaf1b3a601c66b670272ddb5e197ca39bdb822581f50542d039f4de38090940948b3bbb9d9b457d9842e65a5337cd1e2a20601a91a3b9ac9ff581f50542d14dbf80c8fbab3e59f2e2b2e0eb39a57adce8b4476feeb51c1ce0caf1a3b9ac9ff581f50542d2529958bb1c6df1d1d60f11db4531fa60ae8e4cd359e8f1449a660e21a3b9ac9ff581f50542d36c9a2f070c551bd0272ab4dd26107710a65d8c5b400b4f98337c7971a3b9ac9ff581f50542d49eaa3baac0f2cbd4d94f9cb0897ddad451772a852c516f56df013e21a3b9ac9ff581f50542d62689b4f6ac9eca21e6038a1192226b26bf444a8bd233ebd174fbb3f1a3b9ac9ff581f50542d633c51da90a8fa6ba17d832b6b5097b63600d8db5d5e06eeb82a8c511a3b9ac9ff581f50542d7ac65983019a9a463e988cafa1b833fc51b127691e19e812f0a8ba2a1a3b9ac9ff581f59542d86b63fb3409c42993f0bd82ecd23bb903b74ad1e8f7b3ff127071eaf1a3b9ac9ff581f59542d937c809e3125d8ff4bfb384fed7d401f8ab89324c6a186596abb5ee91a3b9ac9ff581f59542d93b3df7ccdf67978eaa14d63cfbb993d37f97bfc095c95710c140cb41a3b9ac9ff581f59542db30db3498a7c7e8bcdf1ec1cb4198651f3203dcd524479cbcb05a4a51a3b9ac9ff581f59542de0429c21147689204970535691f0858e6f1defb1a4a05c1fed75759c1a3b9ac9ff581f59542de71d67d7dfee5426e8e14d7e2b3f3deb58c990288ad3f1a5a5a1f1e71a3b9ac9ff581f59542dedd5e8a4cf2b03d18e1dadefa00943d7fbf01cb54f0269db00fab2af1a3b9ac9ff581f59542df844b76d88dee4ee7822ebaea6e2691b9e65ac416fc5b91232362e051a3b9ac9ff581f59542df8b3717986dae46d176083dd1a73297620b83959cf8fabd196cbab511a3b9ac9ff581ce1da93520ba2ba5036f9887df4dc674adb581bf1d5a8d010b4499d54a14d6868686820000301995a9957d81a05f5e100581ce1a6483473a5d6108ed2ed7f452a2d5b3bec5aeabbe333bf5e6b2505ad582004ebea1bbd150c06ef931f8c78b24ff709adc0174c3cab4987d6407d94cd076e01582012dcefc8ab17845ee4964a7683ad94d53d24be8f35355ac1a691cf9a479fffd60158203a5c9a39cdf734c46a43f8c1c0c655cb055f57e3ef745fa1f39cee5a504351ab0158203dda29a4736b0fa1e8bd16c7790a2f66eefd4fb71d272d8767950daa1431d886015820593a9099989e1c7cabec39f7514c861a022a830447a621ea3c700fd6163f887a01582060c037785ac6ac5b60f13389dc7e8af9ef60de53cc38ff2cfd669123f82571fd01582092bec252f2f7aa4c897dac25f07f3771de89c5aeb0e76566d2fb5d8734209c9f015820b1002da875bf27861c31529f2c6fae0f99fe985daf05205b97a95b1905075d13015820b487baf2a0c5c90c04ee25be16176b09abce23ea18103e6b7b5f9802ee3f0d99015820e5e0dbf8a8f2f53ea503584838f15da18005889e2dc25b133dcf963b98ad0ece015820ea12664fede1624b5f773cf616fb82a0dc2f16800d30fd39b750c6eb68deab2b015820eb1947e6d39b7cc3a87fd0325c657152607187722e5d6db6c73e16c9a8e33d8e015820f033f5521d2ea201e1eb2089990f3c01c45865ced38e634ce222cbc6961e1a8101581c919d4c2c9455016289341b1a14dedf697687af31751170d56a31466ead4574414749581b00000145f680b0004574434f50491b0000000342770c0044744441491b0000000342770c004574444a45441b000000025cb7acc944744552471b00000cbba106e00044744941471b0000000342770c004574495553441b0000000342770c0044744d494e1b0000000342770c0045745348454e1b0000000342770c004574534e454b1936b04574555344431b00000145f680bd6c4574555344541b00000145f680b0004474574d541b0000000342770c00581c7b595fd9e70b625caeace2e20ac91f292e4cc7f510a23fb71916b76ba2581c32c41815d270a4cc8be4bc9d3d171546b44d36cb57aa7b8b056185581ae207a898581ce730c8f5f0fc2de450355dde681293c9781b22045be8c65fcbbb62161a76870d72581c349124259ba9beec3e1a43673c6cc0298f87aa9da7be1df7568e2d0ca1401828581c191b632d0911b46aca61570d90c45967bd45561757647e8634611eaaa15820cb361d50bc70fb608e35bf8e5624bda6b3456a1b538a3d91d4344ed1909d185c0a111a004c4b4012d901028c82582015c60cb9a9b8783d6310844dbfef11239b33a10e4c30d80f387b5653de80b38500825820367dda134c1341bfb3af980627540e213c909a7618972e2a50c6b7ee01ddcfe3008258204bd11ee91e4b1e8322f094a3dc9b92eb9a28036580ef35012b4261234df8f321008258208a7b8a548cb04398eaa78e4160046f749e5ba865168489e751a173c3a99266ea00825820a64d419e6d45e05d7c29fe158bb4528dd145172d52d3ea21bc90362eb42f6d2300825820ae98a2ad6804b0638cb0589d5390e3fedc515d79d555ac497ee0ec3fdb55482400825820c0ff515afd3dc5b5e1ae0242ce6aa1e1ac58bcd93e3672d38be7dc31d256bf2600825820c2e5a4d2c2b1d5d26a80f2675d53e4a64058f4e9745868c133090aab9952936a00825820c4af5ec19e3c78295ceee0d65be77132c991bd93350642fbadae3342cd70874200825820cb0cbaf47214ecc9284e204bb593842c48e5c820cf8eb8364fdfec288ffdc01200825820cb65a0baf837a3c079f3b38133dc6e8ce1e42db2159b03209ed8668d2ae2c19800825820fd3406c4a6e51e21178542e0370d37acd996aab26d744d7afef09c73ca123f6800a10585840001d87b9f059fd8799f00d87a8008ffffff821a0001e3181a026be8a6840002d8799fd87b9f0103ff0220070402ff821a00020b721a02f715a6840100d87b9f059fd8799f00d87a8008ffffff821a001043f11a153d9355840101d8799fd87b9f0103ff0220070402ff821a000eab871a13473e49840300d8799f099f06ff9f9fd87a80d87e8000ff9fd87980d90500800bff9fd87980d905018001ffffa19f4040ffa39f581c7aa4312097def38936c7b69fb380f9e8685dfa17c52c68151781ea0340ffd8799f1b000000bc4ae316821b000000b29fb72acfff9f581c7b595fd9e70b625caeace2e20ac91f292e4cc7f510a23fb71916b76b581c32c41815d270a4cc8be4bc9d3d171546b44d36cb57aa7b8b05618558ffd8799f1b0000002adc4f03cb1b0000002a84a1774eff9f581c919d4c2c9455016289341b1a14dedf697687af31751170d56a31466e4574444a4544ffd8799f1a0003623e1a00026013ffa19f581c7b595fd9e70b625caeace2e20ac91f292e4cc7f510a23fb71916b76b581c32c41815d270a4cc8be4bc9d3d171546b44d36cb57aa7b8b05618558ff1901f4ff821a001ff3e81a28d5584ef5f6";

  try {
    const lucid: LucidEvolution = await Lucid(
      new Kupmios("http://172.16.61.2:1442", "http://172.16.61.4:1337"),
      "Preview"
    );

    lucid.selectWallet.fromSeed(seedPhrase, {
      accountIndex: 1,
    });

    // 1. Load the transaction from the CBOR string
    const txToSign = lucid.fromTx(txCbor);

    // 2. Sign the transaction with the wallet
    const signedTx = await txToSign.sign.withWallet().complete();

    // 3. Submit the signed transaction
    const txHash = await signedTx.submit();

    console.log(`Successfully submitted transaction!`);
    console.log(`Tx Hash: ${txHash}`);
    console.log(`https://preview.cardanoscan.io/transaction/${txHash}`);
  } catch (e) {
    console.error("Failed to submit raw transaction:", e);
  }
};

const simple = async () => {
  const samples = [
    { label: 674, data: ["msg", ["abc1234"] ] }, // ✅ array
  ];

  for (const s of samples) {
    try {
      const lucid: LucidEvolution = await Lucid(
        new Blockfrost(
          "https://cardano-preview.blockfrost.io/api/v0",
          "previewFXVEf9xh8CIKeXDimSww7HCUumrxN22w"
        ),
        "Preview"
      );

      const accountIndexToUse = 1;

      // ✅ correct way to select wallet from seed
      lucid.selectWallet.fromSeed(seedPhrase, {
        accountIndex: accountIndexToUse,
      });

      const addr = await lucid.wallet().address();
      // build tx
      let tx = lucid
        .newTx()
        .pay.ToAddress("addr_test1qqmesf3ascljjeud8c45txn4z4yv63rdyep7vtckdjwudvf232nj4jhfph0vgc8dmjs4mfwmmxgsvwwlvt79htwafu2stywrh5", { lovelace: 2_000_000n })
    tx = tx.attachMetadata(s.label, s.data)
        const txSigned = await tx.complete(); 

      // ✅ sign + submit
      const signed = await txSigned.sign.withWallet().complete();
      const txHash = await signed.submit();

      console.log("SUCCESS for", s, "Tx hash:", txHash);
    } catch (e) {
      console.error("FAIL for", s, e);
    }
  }
};

simple();
